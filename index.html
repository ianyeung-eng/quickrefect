<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>即時全身骨架追蹤（2025 最終修好版）</title>
  <style>
    body {font-family: Arial, sans-serif; text-align: center; background:#222; color:#fff; margin:0;}
    #container {margin:30px auto; position:relative; width:640px; height:480px; background:#000; display:inline-block; overflow:hidden;}
    canvas {position:absolute; top:0; left:0;}
    button {margin:20px; padding:15px 30px; font-size:20px; cursor:pointer;}
    #info {margin:20px; font-size:18px; min-height:30px;}
    .warning {color:#ff4444;}
  </style>
</head>
<body>

  <h1>電腦／手機全身骨架即時追蹤</h1>
  <button id="startBtn">開始追蹤</button>
  
  <div id="container">
    <video id="video" width="640" height="480" autoplay playsinline muted></video>
    <canvas id="overlay" width="640" height="480"></canvas>
  </div>
  
  <div id="info">請用 localhost 或 https 開啟此檔案</div>

  <!-- 2025 仍穩定的最新版 -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const info = document.getElementById('info');
    const startBtn = document.getElementById('startBtn');

    // 檢查是否為安全上下文（必須）
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      info.innerHTML = '<span class="warning">錯誤：請用 localhost 或 https 開啟此檔案！<br>直接雙擊檔案會被瀏覽器阻擋攝影機</span>';
      startBtn.disabled = true;
    }

    let model;

    async function init() {
      startBtn.disabled = true;
      info.textContent = '載入模型中…（約 3~8 秒）';

      try {
        // 使用 Google 官方最穩的公開 PoseNet 模型
        const modelURL = "https://storage.googleapis.com/teachablemachine-models/posenet/mobilenet/model.json";
        const metadataURL = "https://storage.googleapis.com/teachablemachine-models/posenet/mobilenet/metadata.json";
        
        model = await tmPose.load(modelURL, metadataURL);
        info.textContent = '模型載入完成！正在請求攝影機…';

        // 關鍵：標準 getUserMedia + facingMode（手機前鏡頭）
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: "user"   // 前鏡頭（手機必加）
          },
          audio: false
        });

        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          info.textContent = '偵測中… 請站到鏡頭前，讓全身入鏡！';
          loop();
        };

      } catch (err) {
        console.error(err);
        info.innerHTML = `<span class="warning">攝影機錯誤：<br>${err.message}</span>`;
        startBtn.disabled = false;
      }
    }

    async function loop() {
      await predict();
      requestAnimationFrame(loop);
    }

    async function predict() {
      if (!model) return;

      try {
        const { pose } = await model.estimatePose(video);

        // 畫攝影機畫面（鏡像翻轉）
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.scale(-1, 1);
        ctx.translate(-canvas.width, 0);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        ctx.restore();

        // 畫骨架（也要跟著翻轉）
        if (pose && pose.score > 0.3) {
          ctx.save();
          ctx.scale(-1, 1);
          ctx.translate(-canvas.width, 0);
          
          tmPose.drawKeypoints(pose.keypoints, 0.6, ctx);
          tmPose.drawSkeleton(pose.keypoints, 0.6, ctx);
          
          ctx.restore();

          info.textContent = `偵測成功！信心度：${pose.score.toFixed(2)}`;
        } else {
          info.textContent = '搜尋人體中…（請站直、全身入鏡、光線充足）';
        }
      } catch (e) {
        console.error(e);
      }
    }

    startBtn.addEventListener('click', init);
  </script>

  <div style="margin:30px; font-size:14px; color:#aaa;">
    使用方法：<br>
    1. 用 VS Code Live Server、Python http.server、或任何本機 server 開啟<br>
    2. 按「開始追蹤」→ 允許攝影機 → 站到鏡頭前<br>
    3. 綠色線條 + 紅點 = 全身骨架
  </div>
</body>
</html>